<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Debug - –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –∫—Ä–æ–∫—ñ–≤ AR-—Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó (AR.js)</title>
    <!-- –î–æ–¥–∞—î–º–æ Three.js -->
    <script src="js/three.js"></script>
    <!-- –î–æ–¥–∞—î–º–æ jsartoolkit5 -->
    <script src="jsartoolkit5/artoolkit.min.js"></script>
    <script src="jsartoolkit5/artoolkit.api.js"></script>
    <!-- –î–æ–¥–∞—î–º–æ threex.artoolkit -->
    <script src="threex/threex-artoolkitcontext.js"></script>
    <script src="threex/threex-arbasecontrols.js"></script>
    <script src="threex/threex-armarkercontrols.js"></script>
    <!-- –î–æ–¥–∞—î–º–æ OpenCV.js –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –æ–±—Ä–æ–±–∫–∏ (–°—Ü–µ–Ω–∞ 1) -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady()" type="text/javascript"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        .subtitle {
            text-align: center;
            margin-bottom: 20px;
            color: #aaa;
            font-size: 14px;
        }

        .scenes-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .scene {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .scene:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }

        .scene-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .scene-number {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .scene-title {
            font-size: 16px;
            font-weight: 600;
        }

        .scene-description {
            font-size: 12px;
            color: #888;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .scene canvas, .scene video {
            width: 100%;
            height: auto;
            border-radius: 8px;
            background: #000;
            display: block;
        }

        .scene-info {
            margin-top: 10px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            font-size: 11px;
            color: #00d4ff;
        }

        .scene-info span {
            display: block;
            margin: 3px 0;
        }

        .controls {
            max-width: 1400px;
            margin: 20px auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }

        .controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-start {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: #000;
        }

        .btn-start:hover {
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .btn-stop {
            background: linear-gradient(135deg, #ff4757, #cc3344);
            color: #fff;
        }

        .btn-stop:hover {
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
        }

        .status {
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 13px;
        }

        .status-ready {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .status-running {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .status-error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—ñ–¥–µ–æ –µ–ª–µ–º–µ–Ω—Ç */
        #arVideo {
            display: none !important;
            position: absolute !important;
            left: -9999px !important;
            top: -9999px !important;
            width: 1px !important;
            height: 1px !important;
        }
        
        /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ canvas —Å—Ç–≤–æ—Ä–µ–Ω—ñ AR.js */
        canvas.arjs-canvas {
            display: none !important;
        }
    </style>
</head>
<body>
    <h1>üîç AR Debug - –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –∫—Ä–æ–∫—ñ–≤ AR-—Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó (AR.js)</h1>
    <p class="subtitle">–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—è —Ä–æ–±–æ—Ç–∏ AR.js –¥–ª—è —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è barcode-–º–∞—Ä–∫–µ—Ä—ñ–≤</p>

    <!-- –ö–æ–Ω—Ç—Ä–æ–ª–∏ -->
    <div class="controls">
        <button class="btn-start" id="btnStart">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∫–∞–º–µ—Ä—É</button>
        <button class="btn-stop" id="btnStop">‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏</button>
        <div class="status status-ready" id="statusStatus">–ì–æ—Ç–æ–≤–∏–π –¥–æ –∑–∞–ø—É—Å–∫—É</div>
    </div>

    <!-- –í—ñ–¥–µ–æ –¥–ª—è AR.js -->
    <video id="arVideo" autoplay playsinline muted crossorigin="anonymous"></video>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è 6 —Å—Ü–µ–Ω -->
    <div class="scenes-container">
        <!-- –°—Ü–µ–Ω–∞ 1: –í–∏—Ö—ñ–¥–Ω–µ –≤—ñ–¥–µ–æ -->
        <div class="scene">
            <div class="scene-header">
                <div class="scene-number">1</div>
                <div class="scene-title">–í–∏—Ö—ñ–¥–Ω–µ –≤—ñ–¥–µ–æ</div>
            </div>
            <p class="scene-description">
                –ü–æ—Ç—ñ–∫ –∑ –∫–∞–º–µ—Ä–∏ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ AR.js
            </p>
            <canvas id="scene1"></canvas>
            <div class="scene-info" id="scene1Info">
                <span>–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</span>
            </div>
        </div>

        <!-- –°—Ü–µ–Ω–∞ 2: –î–µ—Ç–µ–∫—Ç—É–≤–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ä—ñ–≤ -->
        <div class="scene">
            <div class="scene-header">
                <div class="scene-number">2</div>
                <div class="scene-title">–î–µ—Ç–µ–∫—Ç—É–≤–∞–Ω–Ω—è (AR.js)</div>
            </div>
            <p class="scene-description">
                Barcode-–º–∞—Ä–∫–µ—Ä–∏, —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω—ñ AR.js (artoolkit)
            </p>
            <canvas id="scene2"></canvas>
            <div class="scene-info" id="scene2Info">
                <span>–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</span>
            </div>
        </div>

        <!-- –°—Ü–µ–Ω–∞ 3: –ü–æ–∑–∏—Ü—ñ—ó –º–∞—Ä–∫–µ—Ä—ñ–≤ -->
        <div class="scene">
            <div class="scene-header">
                <div class="scene-number">3</div>
                <div class="scene-title">–ü–æ–∑–∏—Ü—ñ—ó –º–∞—Ä–∫–µ—Ä—ñ–≤</div>
            </div>
            <p class="scene-description">
                3D –ø–æ–∑–∏—Ü—ñ—ó —Ç–∞ –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—è –º–∞—Ä–∫–µ—Ä—ñ–≤
            </p>
            <canvas id="scene3"></canvas>
            <div class="scene-info" id="scene3Info">
                <span>–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</span>
            </div>
        </div>

        <!-- –°—Ü–µ–Ω–∞ 4: –°—Ç–∞–Ω –º–∞—Ä–∫–µ—Ä—ñ–≤ -->
        <div class="scene">
            <div class="scene-header">
                <div class="scene-number">4</div>
                <div class="scene-title">–°—Ç–∞–Ω –º–∞—Ä–∫–µ—Ä—ñ–≤</div>
            </div>
            <p class="scene-description">
                inCurrent, inPrevious - —Å—Ç–∞–Ω –¥–µ—Ç–µ–∫—Ç—É–≤–∞–Ω–Ω—è
            </p>
            <canvas id="scene4"></canvas>
            <div class="scene-info" id="scene4Info">
                <span>–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</span>
            </div>
        </div>

        <!-- –°—Ü–µ–Ω–∞ 5: Pose Estimation -->
        <div class="scene">
            <div class="scene-header">
                <div class="scene-number">5</div>
                <div class="scene-title">Pose Estimation</div>
            </div>
            <p class="scene-description">
                Rotation & Translation –∑ AR.js
            </p>
            <canvas id="scene5"></canvas>
            <div class="scene-info" id="scene5Info">
                <span>–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</span>
            </div>
        </div>

        <!-- –°—Ü–µ–Ω–∞ 6: 3D –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è -->
        <div class="scene">
            <div class="scene-header">
                <div class="scene-number">6</div>
                <div class="scene-title">3D –ö–æ–Ω—É—Å</div>
            </div>
            <p class="scene-description">
                –ü—Ä–∏–≤'—è–∑–∫–∞ 3D-–ø—Ä–∏–º—ñ—Ç–∏–≤–∞ –¥–æ –º–∞—Ä–∫–µ—Ä–∞ (Three.js)
            </p>
            <canvas id="scene6"></canvas>
            <div class="scene-info" id="scene6Info">
                <span>–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</span>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü
        // ============================================
        let arToolkitReady = false;
        let video = document.getElementById('arVideo');
        let stream = null;
        let animationId = null;
        
        // AR.js –∑–º—ñ–Ω–Ω—ñ
        let arToolkitContext = null;
        let scene, camera;
        
        // OpenCV –∑–º—ñ–Ω–Ω–∞
        let cvReady = false;
        
        function onOpenCvReady() {
            cvReady = true;
            console.log('‚úÖ OpenCV.js –≥–æ—Ç–æ–≤–∏–π –¥–æ —Ä–æ–±–æ—Ç–∏');
        }
        
        // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è barcode-–º–∞—Ä–∫–µ—Ä—ñ–≤
        let config = null;
        let barcodeMarkerValues = [];
        
        // –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –º–∞—Ä–∫–µ—Ä—ñ–≤
        let lastMarkerStates = {};
        let lastUpdateTime = 0;
        let markerDiagnostics = {};

        // Canvas –¥–ª—è —Å—Ü–µ–Ω
        const canvas1 = document.getElementById('scene1');
        const canvas2 = document.getElementById('scene2');
        const canvas3 = document.getElementById('scene3');
        const canvas4 = document.getElementById('scene4');
        const canvas5 = document.getElementById('scene5');
        const canvas6 = document.getElementById('scene6');

        // Contexts –¥–ª—è —Å—Ü–µ–Ω
        const ctx1 = canvas1.getContext('2d');
        const ctx2 = canvas2.getContext('2d');
        const ctx3 = canvas3.getContext('2d');
        const ctx4 = canvas4.getContext('2d');
        const ctx5 = canvas5.getContext('2d');
        const ctx6 = canvas6.getContext('2d');

        // –†–æ–∑–º—ñ—Ä–∏
        const VIDEO_WIDTH = 640;
        const VIDEO_HEIGHT = 480;

        // ============================================
        // –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø AR.JS
        // ============================================
        let markerRoots = {}; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ markerRoot –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ barcode
        
        function initARjs() {
            console.log('initARjs: video.readyState =', video.readyState);
            
            // –ß–µ–∫–∞—î–º–æ –ø–æ–∫–∏ –≤—ñ–¥–µ–æ –±—É–¥–µ –≥–æ—Ç–æ–≤–µ
            if (video.readyState < 2) {
                console.log('initARjs: –≤—ñ–¥–µ–æ –Ω–µ –≥–æ—Ç–æ–≤–µ, —á–µ–∫–∞—î–º–æ...');
                video.onloadeddata = function() {
                    console.log('initARjs: –≤—ñ–¥–µ–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ, readyState =', video.readyState);
                    initARjsInternal();
                };
            } else {
                initARjsInternal();
            }
        }
        
        function initARjsInternal() {
            // –°—Ç–≤–æ—Ä—é—î–º–æ Three.js —Å—Ü–µ–Ω—É –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó
            scene = new THREE.Scene();
            camera = new THREE.Camera();
            scene.add(camera);

            // –°—Ç–≤–æ—Ä—é—î–º–æ AR.js –∫–æ–Ω—Ç–µ–∫—Å—Ç –±–µ–∑ ArToolkitSource
            arToolkitContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: 'data/camera_para.dat',
                detectionMode: 'mono_and_matrix',
                matrixCodeType: '3x3',
                maxDetectionRate: -1,
                canvasWidth: VIDEO_WIDTH,
                canvasHeight: VIDEO_HEIGHT
            });

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑ –Ω–∞—à–∏–º video –µ–ª–µ–º–µ–Ω—Ç–æ–º
            arToolkitContext.init(function onCompleted() {
                console.log('arToolkitContext.init –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
                arToolkitReady = true;
                updateStatus('üé• AR.js –≥–æ—Ç–æ–≤–∏–π. –û–±—Ä–æ–±–∫–∞...', 'running');
                console.log('‚úÖ AR.js –≥–æ—Ç–æ–≤–∏–π –¥–æ —Ä–æ–±–æ—Ç–∏');
                
                // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ü–∏–∫–ª –æ–±—Ä–æ–±–∫–∏
                processFrame();
                
                // –°—Ç–≤–æ—Ä—é—î–º–æ markerRoot –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ barcode-–º–∞—Ä–∫–µ—Ä–∞ –∑ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
                if (barcodeMarkerValues.length > 0) {
                    barcodeMarkerValues.forEach((barcodeValue) => {
                        // –°—Ç–≤–æ—Ä—é—î–º–æ –≥—Ä—É–ø—É –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞
                        const markerRoot = new THREE.Group();
                        scene.add(markerRoot);
                        markerRoots[barcodeValue] = markerRoot;
                        
                        // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞
                        const markerControls = new THREEx.ArMarkerControls(
                            arToolkitContext,
                            markerRoot,
                            {
                                type: 'barcode',
                                barcodeValue: barcodeValue,
                                size: 35 // matrixSize –∑ config.json
                            }
                        );
                        
                        console.log(`‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –¥–ª—è barcode ${barcodeValue}`);
                    });
                }
            });
        }

        // ============================================
        // –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–á
        // ============================================
        fetch('config.json')
            .then(response => response.json())
            .then(data => {
                config = data;
                if (config && config.markers) {
                    barcodeMarkerValues = config.markers
                        .filter(m => m.type === 'barcode')
                        .map(m => m.target);
                    console.log('‚úÖ Barcode-–º–∞—Ä–∫–µ—Ä–∏ –∑ config.json:', barcodeMarkerValues);
                }
            })
            .catch(error => {
                console.error('‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è config.json:', error);
            });

        // ============================================
        // –§–£–ù–ö–¶–Ü–á –£–ü–†–ê–í–õ–Ü–ù–ù–Ø
        // ============================================
        document.getElementById('btnStart').addEventListener('click', startCamera);
        document.getElementById('btnStop').addEventListener('click', stopCamera);

        async function startCamera() {
            try {
                // –ó–∞–ø–∏—Ç—É—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: VIDEO_WIDTH },
                        height: { ideal: VIDEO_HEIGHT },
                        facingMode: 'environment'
                    }
                });

                // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–µ–æ –ø–æ—Ç—ñ–∫
                video.srcObject = stream;

                // –ß–µ–∫–∞—î–º–æ –ø–æ–∫–∏ –≤—ñ–¥–µ–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è
                await new Promise(resolve => {
                    video.onloadeddata = resolve;
                    video.play();
                });

                // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–∑–º—ñ—Ä–∏ canvas
                setupCanvasSizes();

                // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ AR.js
                initARjs();

            } catch (err) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É –∫–∞–º–µ—Ä–∏:', err);
                updateStatus('–ü–æ–º–∏–ª–∫–∞: ' + err.message, 'error');
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            if (arToolkitContext) {
                arToolkitContext = null;
            }
            
            // –û—á–∏—â–∞—î–º–æ —Å—Ü–µ–Ω–∏
            [ctx1, ctx2, ctx3, ctx4, ctx5, ctx6].forEach(ctx => {
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);
            });

            updateStatus('–ó—É–ø–∏–Ω–µ–Ω–æ', 'ready');
            arToolkitReady = false;
        }

        function setupCanvasSizes() {
            [canvas1, canvas2, canvas3, canvas4, canvas5, canvas6].forEach(canvas => {
                canvas.width = VIDEO_WIDTH;
                canvas.height = VIDEO_HEIGHT;
            });
        }

        function updateStatus(message, type) {
            const statusEl = document.getElementById('statusStatus');
            statusEl.textContent = message;
            statusEl.className = 'status status-' + type;
        }

        // ============================================
        // –ì–û–õ–û–í–ù–ò–ô –¶–ò–ö–õ –û–ë–†–û–ë–ö–ò –ö–ê–î–†–Ü–í
        // ============================================
        let frameCount = 0;
        
        function processFrame() {
            console.log(`processFrame: stream=${!!stream}, paused=${video.paused}, ended=${video.ended}, ready=${arToolkitReady}, readyState=${video.readyState}`);
            
            if (!stream || video.paused || video.ended || !arToolkitReady) {
                animationId = requestAnimationFrame(processFrame);
                return;
            }

            try {
                // –û–Ω–æ–≤–ª—é—î–º–æ AR.js –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑ –Ω–∞—à–∏–º video –µ–ª–µ–º–µ–Ω—Ç–æ–º
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ arController.process() –¥–ª—è –¥–µ—Ç–µ–∫—Ç—É–≤–∞–Ω–Ω—è
                const arController = arToolkitContext.arController;
                arController.process(video);

                // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –ø—Ä–æ barcode-–º–∞—Ä–∫–µ—Ä–∏ –∑ AR.js
                const barcodeMarkers = arToolkitContext.arController.barcodeMarkers;
                
                // –û–Ω–æ–≤–ª—é—î–º–æ –≤–∏–¥–∏–º—ñ—Å—Ç—å markerRoot –Ω–∞ –æ—Å–Ω–æ–≤—ñ –¥–∞–Ω–∏—Ö AR.js
                barcodeMarkerValues.forEach((barcodeValue) => {
                    const markerRoot = markerRoots[barcodeValue];
                    const marker = barcodeMarkers[barcodeValue];
                    
                    if (markerRoot && marker) {
                        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≤–∏–¥–∏–º—ñ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤—ñ inCurrent
                        markerRoot.visible = (marker.inCurrent === true);
                    }
                });
                
                // –°—Ü–µ–Ω–∞ 1: –í–∏—Ö—ñ–¥–Ω–µ –≤—ñ–¥–µ–æ
                processScene1();
                
                // –°—Ü–µ–Ω–∞ 2: –î–µ—Ç–µ–∫—Ç—É–≤–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ä—ñ–≤ (–æ—Å–Ω–æ–≤–Ω–∞ —Å—Ü–µ–Ω–∞ –∑ –≤—ñ–¥–µ–æ)
                processScene2(barcodeMarkers);
                
                // –°—Ü–µ–Ω–∞ 3: –ü–æ–∑–∏—Ü—ñ—ó –º–∞—Ä–∫–µ—Ä—ñ–≤
                processScene3(barcodeMarkers);
                
                // –°—Ü–µ–Ω–∞ 4: –°—Ç–∞–Ω –º–∞—Ä–∫–µ—Ä—ñ–≤
                processScene4(barcodeMarkers);
                
                // –°—Ü–µ–Ω–∞ 5: Pose Estimation
                processScene5(barcodeMarkers);
                
                // –°—Ü–µ–Ω–∞ 6: 3D –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è
                processScene6(barcodeMarkers);
                
                frameCount++;
            } catch (err) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∫–∞–¥—Ä—É:', err);
            }

            animationId = requestAnimationFrame(processFrame);
        }

        // ============================================
        // –°–¶–ï–ù–ê 1: –ü–û–ü–ï–†–ï–î–ù–Ø –û–ë–†–û–ë–ö–ê (OpenCV)
        // ============================================
        function processScene1() {
            // –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–∏–º—á–∞—Å–æ–≤–∏–π canvas –¥–ª—è OpenCV
            let tempCanvas = document.createElement('canvas');
            tempCanvas.width = VIDEO_WIDTH;
            tempCanvas.height = VIDEO_HEIGHT;
            let tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(video, 0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);

            // –û—Ç—Ä–∏–º—É—î–º–æ ImageData –¥–ª—è –æ–±—Ä–æ–±–∫–∏ OpenCV
            let imageData = tempCtx.getImageData(0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);
            
            if (cvReady && typeof cv !== 'undefined') {
                let src = cv.matFromImageData(imageData);
                let gray = new cv.Mat();
                let blurred = new cv.Mat();
                let thresholded = new cv.Mat();

                try {
                    // –ö—Ä–æ–∫ 1: RGB ‚Üí Grayscale (–ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è —É –≤—ñ–¥—Ç—ñ–Ω–∫–∏ —Å—ñ—Ä–æ–≥–æ)
                    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

                    // –ö—Ä–æ–∫ 2: Gaussian Blur (–∑–º–µ–Ω—à–µ–Ω–Ω—è —à—É–º—É, —è–¥—Ä–æ 5x5)
                    cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0, 0, cv.BORDER_DEFAULT);

                    // –ö—Ä–æ–∫ 3: Adaptive Threshold (–±—ñ–Ω–∞—Ä–∏–∑–∞—Ü—ñ—è)
                    cv.adaptiveThreshold(blurred, thresholded, 255,
                        cv.ADAPTIVE_THRESH_GAUSSIAN_C,
                        cv.THRESH_BINARY_INV,
                        11, // –†–æ–∑–º—ñ—Ä –±–ª–æ–∫—É
                        2   // –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ C
                    );

                    // –ü–æ–∫–∞–∑—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (thresholded)
                    cv.imshow('scene1', thresholded);

                    // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
                    document.getElementById('scene1Info').innerHTML = `
                        <span>üìä –†–æ–∑–º—ñ—Ä: ${VIDEO_WIDTH}x${VIDEO_HEIGHT}</span>
                        <span>‚öôÔ∏è Gaussian: —è–¥—Ä–æ 5√ó5</span>
                        <span>üî≤ Adaptive: –±–ª–æ–∫ 11√ó11, C=2</span>
                        <span>üü§ RGB ‚Üí Grayscale ‚Üí Blur ‚Üí Threshold</span>
                    `;

                } catch (err) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ Scene 1:', err);
                    //fallback - –º–∞–ª—é—î–º–æ –≤—ñ–¥–µ–æ
                    ctx1.drawImage(video, 0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);
                } finally {
                    src.delete();
                    gray.delete();
                    blurred.delete();
                    thresholded.delete();
                }
            } else {
                // OpenCV —â–µ –Ω–µ –≥–æ—Ç–æ–≤–∏–π - –º–∞–ª—é—î–º–æ –≤—ñ–¥–µ–æ
                ctx1.drawImage(video, 0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);
                document.getElementById('scene1Info').innerHTML = `
                    <span>üìä –†–æ–∑–º—ñ—Ä: ${VIDEO_WIDTH}x${VIDEO_HEIGHT}</span>
                    <span>‚è≥ OpenCV –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è...</span>
                `;
            }
        }

        // ============================================
        // –°–¶–ï–ù–ê 2: –î–ï–¢–ï–ö–¢–£–í–ê–ù–ù–Ø –ú–ê–†–ö–ï–†–Ü–í (AR.JS)
        // ============================================
        function processScene2(barcodeMarkers) {
            console.log('processScene2: barcodeMarkers =', barcodeMarkers);
            console.log('processScene2: arToolkitContext =', arToolkitContext);
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤—ñ–¥–µ–æ –≥–æ—Ç–æ–≤–µ
            if (video.readyState >= 2) {
                // –ú–∞–ª—é—î–º–æ –≤–∏—Ö—ñ–¥–Ω–µ –≤—ñ–¥–µ–æ –Ω–∞ canvas —Å—Ü–µ–Ω–∏ 2
                ctx2.drawImage(video, 0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);
            } else {
                // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è
                ctx2.fillStyle = '#1a1a2e';
                ctx2.fillRect(0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);
                ctx2.fillStyle = '#ffffff';
                ctx2.font = 'bold 20px Arial';
                ctx2.textAlign = 'center';
                ctx2.fillText('–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≤—ñ–¥–µ–æ...', VIDEO_WIDTH / 2, VIDEO_HEIGHT / 2);
                return;
            }

            let detectedCount = 0;
            const currentTime = performance.now();
            const timeDelta = currentTime - (lastUpdateTime || currentTime);
            lastUpdateTime = currentTime;

            // –û—Ç—Ä–∏–º—É—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ arController –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è 2D –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            const arController = arToolkitContext.arController;
            
            console.log('processScene2: arController =', arController);

            // –û—Ç—Ä–∏–º—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –¥–µ—Ç–µ–∫—Ç–æ–≤–∞–Ω–∏—Ö –º–∞—Ä–∫–µ—Ä—ñ–≤
            const markerNum = arController.getMarkerNum();
            
            console.log('processScene2: markerNum =', markerNum);
            
            // –ü—Ä–æ—Ö–æ–¥–∏–º–æ –ø–æ –≤—Å—ñ—Ö –¥–µ—Ç–µ–∫—Ç–æ–≤–∞–Ω–∏—Ö –º–∞—Ä–∫–µ—Ä–∞—Ö
            for (let i = 0; i < markerNum; i++) {
                const markerInfo = arController.getMarker(i);
                
                if (!markerInfo) continue;
                
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ç–∏–ø –º–∞—Ä–∫–µ—Ä–∞ (BARCODE_MARKER = 1)
                const isBarcode = markerInfo.idMatrix >= 0;
                
                if (isBarcode) {
                    const barcodeValue = markerInfo.idMatrix;
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ –º–∞—Ä–∫–µ—Ä –∑ –Ω–∞—à–æ—ó –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
                    if (!barcodeMarkerValues.includes(barcodeValue)) continue;
                    
                    const markerRoot = markerRoots[barcodeValue];
                    const arMarker = barcodeMarkers[barcodeValue];
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –º–∞—Ä–∫–µ—Ä –≤–∏–¥–∏–º–∏–π
                    if (markerRoot && arMarker && arMarker.inCurrent === true) {
                        detectedCount++;
                        
                        // –û—Ç—Ä–∏–º—É—î–º–æ 2D –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –∫—É—Ç—ñ–≤ –∑ markerInfo.vertex
                        const vertex = markerInfo.vertex;
                        
                        console.log(`–ú–∞—Ä–∫–µ—Ä ${barcodeValue} vertex:`, vertex);
                        
                        if (vertex && vertex.length >= 4) {
                            // vertex - —Ü–µ 2D –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ [[x0,y0], [x1,y1], ...]
                            const corners = [
                                { x: vertex[0][0], y: vertex[0][1] },
                                { x: vertex[1][0], y: vertex[1][1] },
                                { x: vertex[2][0], y: vertex[2][1] },
                                { x: vertex[3][0], y: vertex[3][1] }
                            ];
                            
                            console.log(`–ú–∞—Ä–∫–µ—Ä ${barcodeValue} corners:`, corners);
                            
                            // –ú–∞–ª—é—î–º–æ –∫–æ–Ω—Ç—É—Ä –º–∞—Ä–∫–µ—Ä–∞ (–∑–µ–ª–µ–Ω–∏–π)
                            ctx2.strokeStyle = '#00ff00';
                            ctx2.lineWidth = 3;
                            ctx2.beginPath();
                            ctx2.moveTo(corners[0].x, corners[0].y);
                            ctx2.lineTo(corners[1].x, corners[1].y);
                            ctx2.lineTo(corners[2].x, corners[2].y);
                            ctx2.lineTo(corners[3].x, corners[3].y);
                            ctx2.closePath();
                            ctx2.stroke();
                            
                            // –ú–∞–ª—é—î–º–æ —á–µ—Ä–≤–æ–Ω—ñ —Ç–æ—á–∫–∏ –Ω–∞ –∫—É—Ç–∞—Ö
                            for (let corner of corners) {
                                ctx2.beginPath();
                                ctx2.arc(corner.x, corner.y, 5, 0, 2 * Math.PI);
                                ctx2.fillStyle = '#ff0000';
                                ctx2.fill();
                            }
                            
                            // –ú–∞–ª—é—î–º–æ —Ü–µ–Ω—Ç—Ä –º–∞—Ä–∫–µ—Ä–∞
                            const centerX = (corners[0].x + corners[1].x + corners[2].x + corners[3].x) / 4;
                            const centerY = (corners[0].y + corners[1].y + corners[2].y + corners[3].y) / 4;
                            ctx2.beginPath();
                            ctx2.arc(centerX, centerY, 8, 0, 2 * Math.PI);
                            ctx2.fillStyle = '#00d4ff';
                            ctx2.fill();
                            ctx2.strokeStyle = '#ffffff';
                            ctx2.lineWidth = 2;
                            ctx2.stroke();
                            
                            // –ú–∞–ª—é—î–º–æ ID –º–∞—Ä–∫–µ—Ä–∞
                            ctx2.fillStyle = '#00ff00';
                            ctx2.font = 'bold 16px Arial';
                            ctx2.fillText(`ID:${barcodeValue}`, corners[0].x + 10, corners[0].y + 20);
                        }
                    }
                }
            }
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —á–∞—Å –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
            lastUpdateTime = currentTime;
            
            // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –º–∞—Ä–∫–µ—Ä–∏ –∑ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            Object.keys(markerDiagnostics).forEach(key => {
                if (currentTime - markerDiagnostics[key].lastSeen > 1000) {
                    delete markerDiagnostics[key];
                }
            });
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
            document.getElementById('scene2Info').innerHTML = `
                <span>üîç Barcode-–º–∞—Ä–∫–µ—Ä—ñ–≤ –≤ config: ${barcodeMarkerValues.length}</span>
                <span>‚úÖ –î–µ—Ç–µ–∫—Ç–æ–≤–∞–Ω–æ: ${detectedCount}</span>
                <span>üì¶ AR.js detection</span>
                <span>‚è± Frame: ${timeDelta.toFixed(1)}ms</span>
            `;
        }

        // ============================================
        // –°–¶–ï–ù–ê 3: –ü–û–ó–ò–¶–Ü–á –ú–ê–†–ö–ï–†–Ü–í
        // ============================================
        function processScene3(barcodeMarkers) {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤—ñ–¥–µ–æ –≥–æ—Ç–æ–≤–µ
            if (video.readyState < 2) return;
            
            // –ú–∞–ª—é—î–º–æ –≤—ñ–¥–µ–æ –Ω–∞ —Ñ–æ–Ω—ñ
            ctx3.drawImage(video, 0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);

            let visibleCount = 0;

            barcodeMarkerValues.forEach((barcodeValue) => {
                const markerRoot = markerRoots[barcodeValue];

                if (markerRoot && markerRoot.visible) {
                    visibleCount++;

                    // –û—Ç—Ä–∏–º—É—î–º–æ 2D –∫—É—Ç–∏ –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó
                    const corners = getMarkerCorners(markerRoot, VIDEO_WIDTH, VIDEO_HEIGHT);

                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∫—É—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω—ñ –∫–æ—Ä–µ–∫—Ç–Ω–æ
                    if (!corners || corners.length !== 4) return;

                    // –ú–∞–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –º–∞—Ä–∫–µ—Ä–∞
                    ctx3.strokeStyle = '#ffa500';
                    ctx3.lineWidth = 2;
                    ctx3.beginPath();
                    ctx3.moveTo(corners[0].x, corners[0].y);
                    ctx3.lineTo(corners[1].x, corners[1].y);
                    ctx3.lineTo(corners[2].x, corners[2].y);
                    ctx3.lineTo(corners[3].x, corners[3].y);
                    ctx3.closePath();
                    ctx3.stroke();

                    // –ú–∞–ª—é—î–º–æ 3D –ø–æ–∑–∏—Ü—ñ—é
                    const pos = markerRoot.position;
                    ctx3.fillStyle = '#00d4ff';
                    ctx3.font = 'bold 12px Arial';
                    ctx3.fillText(`Pos: [${pos.x.toFixed(2)}, ${pos.y.toFixed(2)}, ${pos.z.toFixed(2)}]`,
                        corners[0].x, corners[3].y + 20);
                }
            });
            
            document.getElementById('scene3Info').innerHTML = `
                <span>üìç –í–∏–¥–∏–º–∏—Ö –º–∞—Ä–∫–µ—Ä—ñ–≤: ${visibleCount}</span>
                <span>üéØ Three.js –ø–æ–∑–∏—Ü—ñ—ó</span>
            `;
        }

        // ============================================
        // –°–¶–ï–ù–ê 4: –°–¢–ê–ù –ú–ê–†–ö–ï–†–Ü–í
        // ============================================
        function processScene4(barcodeMarkers) {
            // –û—á–∏—â–∞—î–º–æ canvas
            ctx4.fillStyle = '#1a1a2e';
            ctx4.fillRect(0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);
            
            let y = 40;
            const lineHeight = 30;
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
            ctx4.fillStyle = '#ffffff';
            ctx4.font = 'bold 16px Arial';
            ctx4.textAlign = 'center';
            ctx4.fillText('–°—Ç–∞–Ω barcode-–º–∞—Ä–∫–µ—Ä—ñ–≤', VIDEO_WIDTH / 2, y);
            y += lineHeight;
            
            barcodeMarkerValues.forEach((barcodeValue) => {
                const markerRoot = markerRoots[barcodeValue];
                const isVisible = markerRoot && markerRoot.visible;
                const wasVisible = markerDiagnostics[barcodeValue] && 
                                   markerDiagnostics[barcodeValue].visible;
                
                // –ö–æ–ª—ñ—Ä –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å—Ç–∞–Ω—É
                ctx4.fillStyle = isVisible ? '#00ff00' : '#ff4444';
                ctx4.font = 'bold 14px Arial';
                ctx4.textAlign = 'left';
                ctx4.fillText(`ID ${barcodeValue}:`, 20, y);
                
                ctx4.fillStyle = isVisible ? '#00ff00' : '#888888';
                ctx4.font = '12px Arial';
                ctx4.fillText(`Visible: ${isVisible ? 'YES' : 'NO'}`, 120, y);
                
                ctx4.fillStyle = wasVisible ? '#00ff00' : '#888888';
                ctx4.fillText(`Prev: ${wasVisible ? 'YES' : 'NO'}`, 280, y);
                
                y += lineHeight;
            });
            
            document.getElementById('scene4Info').innerHTML = `
                <span>üìä Visible / Previous</span>
                <span>üü¢ = –¥–µ—Ç–µ–∫—Ç–æ–≤–∞–Ω–æ, üî¥ = –≤—Ç—Ä–∞—á–µ–Ω–æ</span>
            `;
        }

        // ============================================
        // –°–¶–ï–ù–ê 5: POSE ESTIMATION
        // ============================================
        function processScene5(barcodeMarkers) {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤—ñ–¥–µ–æ –≥–æ—Ç–æ–≤–µ
            if (video.readyState < 2) return;
            
            // –ú–∞–ª—é—î–º–æ –≤—ñ–¥–µ–æ –Ω–∞ —Ñ–æ–Ω—ñ
            ctx5.drawImage(video, 0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);

            let poseCount = 0;

            barcodeMarkerValues.forEach((barcodeValue) => {
                const markerRoot = markerRoots[barcodeValue];

                if (markerRoot && markerRoot.visible) {
                    poseCount++;

                    // –û—Ç—Ä–∏–º—É—î–º–æ 2D –∫—É—Ç–∏
                    const corners = getMarkerCorners(markerRoot, VIDEO_WIDTH, VIDEO_HEIGHT);
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∫—É—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω—ñ –∫–æ—Ä–µ–∫—Ç–Ω–æ
                    if (!corners || corners.length !== 4) return;

                    // –ú–∞–ª—é—î–º–æ –æ—Å—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                    drawAxes(ctx5, corners[0]);

                    // –û—Ç—Ä–∏–º—É—î–º–æ –æ–±–µ—Ä—Ç–∞–Ω–Ω—è
                    const euler = new THREE.Euler().setFromQuaternion(markerRoot.quaternion, 'XYZ');
                    const rotX = (euler.x * 180 / Math.PI).toFixed(1);
                    const rotY = (euler.y * 180 / Math.PI).toFixed(1);
                    const rotZ = (euler.z * 180 / Math.PI).toFixed(1);

                    // –ú–∞–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø–æ–∑—É
                    ctx5.fillStyle = '#00d4ff';
                    ctx5.font = '11px Arial';
                    ctx5.fillText(`R: [${rotX}¬∞, ${rotY}¬∞, ${rotZ}¬∞]`, corners[0].x + 10, corners[0].y + 40);
                }
            });
            
            document.getElementById('scene5Info').innerHTML = `
                <span>üîÑ Pose Estimation: ${poseCount}</span>
                <span>üìç Rotation & Translation</span>
            `;
        }

        // ============================================
        // –°–¶–ï–ù–ê 6: 3D –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–Ø (–ö–û–ù–£–°)
        // ============================================
        function processScene6(barcodeMarkers) {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –≤—ñ–¥–µ–æ –≥–æ—Ç–æ–≤–µ
            if (video.readyState < 2) return;
            
            // –ú–∞–ª—é—î–º–æ –≤—ñ–¥–µ–æ –Ω–∞ —Ñ–æ–Ω—ñ
            ctx6.drawImage(video, 0, 0, VIDEO_WIDTH, VIDEO_HEIGHT);

            let coneCount = 0;

            barcodeMarkerValues.forEach((barcodeValue) => {
                const markerRoot = markerRoots[barcodeValue];

                if (markerRoot && markerRoot.visible) {
                    coneCount++;

                    // –û—Ç—Ä–∏–º—É—î–º–æ 2D –∫—É—Ç–∏
                    const corners = getMarkerCorners(markerRoot, VIDEO_WIDTH, VIDEO_HEIGHT);
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∫—É—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω—ñ –∫–æ—Ä–µ–∫—Ç–Ω–æ
                    if (!corners || corners.length !== 4) return;

                    // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ü–µ–Ω—Ç—Ä
                    const centerX = (corners[0].x + corners[1].x + corners[2].x + corners[3].x) / 4;
                    const centerY = (corners[0].y + corners[1].y + corners[2].y + corners[3].y) / 4;
                    
                    // –†–æ–∑–º—ñ—Ä –∫–æ–Ω—É—Å–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –≤—ñ–¥—Å—Ç–∞–Ω—ñ (z –ø–æ–∑–∏—Ü—ñ—ó)
                    const coneHeight = Math.min(80, 150 / (Math.abs(markerRoot.position.z) + 0.5));
                    const coneRadius = coneHeight * 0.4;
                    
                    // –í–µ—Ä—à–∏–Ω–∞ –∫–æ–Ω—É—Å–∞
                    const apexX = centerX - markerRoot.position.x * 50;
                    const apexY = centerY - coneHeight - markerRoot.position.y * 50;
                    
                    // –ú–∞–ª—é—î–º–æ –∫–æ–Ω—É—Å
                    ctx6.save();
                    
                    // –¢—ñ–Ω—å
                    ctx6.beginPath();
                    ctx6.ellipse(centerX, centerY + 5, coneRadius, coneRadius * 0.3, 0, 0, Math.PI * 2);
                    ctx6.fillStyle = 'rgba(0, 0, 0, 0.3)';
                    ctx6.fill();
                    
                    // –û—Å–Ω–æ–≤–∞
                    ctx6.beginPath();
                    ctx6.ellipse(centerX, centerY, coneRadius, coneRadius * 0.5, 0, 0, Math.PI * 2);
                    ctx6.fillStyle = 'rgba(0, 212, 255, 0.3)';
                    ctx6.fill();
                    ctx6.strokeStyle = '#00d4ff';
                    ctx6.lineWidth = 2;
                    ctx6.stroke();
                    
                    // –ë—ñ—á–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏
                    ctx6.beginPath();
                    ctx6.moveTo(apexX, apexY);
                    ctx6.lineTo(centerX - coneRadius, centerY);
                    ctx6.lineTo(centerX + coneRadius, centerY);
                    ctx6.closePath();
                    
                    const gradient = ctx6.createLinearGradient(apexX, apexY, centerX, centerY);
                    gradient.addColorStop(0, 'rgba(0, 212, 255, 0.9)');
                    gradient.addColorStop(1, 'rgba(0, 153, 204, 0.7)');
                    ctx6.fillStyle = gradient;
                    ctx6.fill();
                    ctx6.strokeStyle = '#00d4ff';
                    ctx6.lineWidth = 2;
                    ctx6.stroke();
                    
                    // –í–µ—Ä—à–∏–Ω–∞
                    ctx6.beginPath();
                    ctx6.arc(apexX, apexY, 3, 0, Math.PI * 2);
                    ctx6.fillStyle = '#ffffff';
                    ctx6.fill();
                    
                    // ID –º–∞—Ä–∫–µ—Ä–∞
                    ctx6.fillStyle = '#00ff00';
                    ctx6.font = 'bold 12px Arial';
                    ctx6.fillText(`ID:${barcodeValue}`, apexX + 10, apexY - 10);
                    
                    ctx6.restore();
                }
            });
            
            document.getElementById('scene6Info').innerHTML = `
                <span>üî∫ –ö–æ–Ω—É—Å—ñ–≤: ${coneCount}</span>
                <span>üéØ –ú–∞—Ä–∫–µ—Ä—ñ–≤: ${coneCount}</span>
                <span>üìç 3D –ø—Ä–∏–≤'—è–∑–∫–∞ (Three.js)</span>
            `;
        }

        // ============================================
        // –î–û–ü–û–ú–Ü–ñ–ù–Ü –§–£–ù–ö–¶–Ü–á
        // ============================================

        /**
         * –û—Ç—Ä–∏–º—É—î 2D –∫—É—Ç–∏ –º–∞—Ä–∫–µ—Ä–∞ –∑ –º–∞—Ç—Ä–∏—Ü—ñ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è AR.js
         * AR.js –ø–æ–≤–µ—Ä—Ç–∞—î 12 –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ (3x4 –º–∞—Ç—Ä–∏—Ü—è)
         */
        function getCornersFromARMatrix(transform, videoWidth, videoHeight) {
            // –†–æ–∑–º—ñ—Ä –º–∞—Ä–∫–µ—Ä–∞ (AR.js –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –æ–¥–∏–Ω–∏—á–Ω–∏–π —Ä–æ–∑–º—ñ—Ä)
            const size = 0.5;

            // –õ–æ–∫–∞–ª—å–Ω—ñ –∫—É—Ç–∏ –º–∞—Ä–∫–µ—Ä–∞
            const localCorners = [
                { x: -size, y: size, z: 0 },   // topLeft
                { x: size, y: size, z: 0 },    // topRight
                { x: size, y: -size, z: 0 },   // bottomRight
                { x: -size, y: -size, z: 0 }   // bottomLeft
            ];

            // –ü—Ä–æ–µ–∫—Ç—É—î–º–æ —É 2D –ø—Ä–æ—Å—Ç—ñ—Ä
            const projectedCorners = [];

            // AR.js –º–∞—Ç—Ä–∏—Ü—è 3x4 (12 –µ–ª–µ–º–µ–Ω—Ç—ñ–≤):
            // [0-2] = –ø–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ (X)
            // [3-5] = –¥—Ä—É–≥–∏–π —Ä—è–¥–æ–∫ (Y)  
            // [6-8] = —Ç—Ä–µ—Ç—ñ–π —Ä—è–¥–æ–∫ (Z)
            // [9-11] = —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—è (X, Y, Z)
            
            for (let i = 0; i < localCorners.length; i++) {
                const corner = localCorners[i];
                
                // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –º–∞—Ç—Ä–∏—Ü—é –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è 3x4
                const x = transform[0] * corner.x + transform[1] * corner.y + transform[2] * corner.z + transform[9];
                const y = transform[3] * corner.x + transform[4] * corner.y + transform[5] * corner.z + transform[10];
                const z = transform[6] * corner.x + transform[7] * corner.y + transform[8] * corner.z + transform[11];

                // –ü—Ä–æ–µ–∫—Ü—ñ—è –Ω–∞ –µ–∫—Ä–∞–Ω –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ñ–æ–∫—É—Å–Ω–æ—ó –≤—ñ–¥—Å—Ç–∞–Ω—ñ –∫–∞–º–µ—Ä–∏
                // AR.js –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –ø—Ä–æ–µ–∫—Ü—ñ—é
                const projX = (x / z) * videoWidth / 2 + videoWidth / 2;
                const projY = (-y / z) * videoHeight / 2 + videoHeight / 2;
                
                projectedCorners.push({ x: projX, y: projY });
            }

            return projectedCorners;
        }

        /**
         * –û—Ç—Ä–∏–º—É—î 2D –∫—É—Ç–∏ –º–∞—Ä–∫–µ—Ä–∞ –∑ Three.js –æ–±'—î–∫—Ç–∞
         */
        function getMarkerCorners(markerRoot, videoWidth, videoHeight) {
            // AR.js –º–∞—Ä–∫–µ—Ä –º–∞—î —Ä–æ–∑–º—ñ—Ä 1 –æ–¥–∏–Ω–∏—Ü—é
            const size = 0.5;

            // –õ–æ–∫–∞–ª—å–Ω—ñ –∫—É—Ç–∏ –º–∞—Ä–∫–µ—Ä–∞ (—É –ª–æ–∫–∞–ª—å–Ω–æ–º—É –ø—Ä–æ—Å—Ç–æ—Ä—ñ –º–∞—Ä–∫–µ—Ä–∞)
            const localCorners = [
                new THREE.Vector3(-size, size, 0),   // topLeft
                new THREE.Vector3(size, size, 0),    // topRight
                new THREE.Vector3(size, -size, 0),   // bottomRight
                new THREE.Vector3(-size, -size, 0)   // bottomLeft
            ];

            // –û—Ç—Ä–∏–º—É—î–º–æ –º–∞—Ç—Ä–∏—Ü—é –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑ AR.js
            // AR.js –∑–±–µ—Ä—ñ–≥–∞—î –º–∞—Ç—Ä–∏—Ü—é —É markerRoot.matrix
            const matrix = markerRoot.matrix;
            
            // –ü—Ä–æ–µ–∫—Ç—É—î–º–æ —É 2D –ø—Ä–æ—Å—Ç—ñ—Ä
            const projectedCorners = [];

            for (let i = 0; i < localCorners.length; i++) {
                // –ö–æ–ø—ñ—é—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π –∫—É—Ç
                const corner = localCorners[i].clone();
                
                // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –º–∞—Ç—Ä–∏—Ü—é –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è
                corner.applyMatrix4(matrix);

                // –ü—Ä–æ–µ–∫—Ü—ñ—è –Ω–∞ –µ–∫—Ä–∞–Ω (Three.js –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î -Z —è–∫ –Ω–∞–ø—Ä—è–º –∫–∞–º–µ—Ä–∏)
                // –¢–æ–º—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ corner.z < -0.1 (–º–∞—Ä–∫–µ—Ä –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ—é)
                if (corner.z < -0.1) {
                    const x = (corner.x / corner.z + 1) * videoWidth / 2;
                    const y = (-corner.y / corner.z + 1) * videoHeight / 2;
                    projectedCorners.push({ x, y });
                }
            }

            return projectedCorners;
        }

        /**
         * –ú–∞–ª—é—î –æ—Å—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
         */
        function drawAxes(ctx, origin) {
            const axisLength = 40;
            
            // –í—ñ—Å—å X (—á–µ—Ä–≤–æ–Ω–∏–π)
            ctx.beginPath();
            ctx.moveTo(origin.x, origin.y);
            ctx.lineTo(origin.x + axisLength, origin.y);
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.fillStyle = '#ff0000';
            ctx.font = 'bold 12px Arial';
            ctx.fillText('X', origin.x + axisLength + 5, origin.y);
            
            // –í—ñ—Å—å Y (–∑–µ–ª–µ–Ω–∏–π)
            ctx.beginPath();
            ctx.moveTo(origin.x, origin.y);
            ctx.lineTo(origin.x, origin.y + axisLength);
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.fillStyle = '#00ff00';
            ctx.fillText('Y', origin.x, origin.y + axisLength + 12);
            
            // –í—ñ—Å—å Z (—Å–∏–Ω—ñ–π)
            ctx.beginPath();
            ctx.moveTo(origin.x, origin.y);
            ctx.lineTo(origin.x - axisLength * 0.7, origin.y - axisLength * 0.7);
            ctx.strokeStyle = '#0000ff';
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.fillStyle = '#0000ff';
            ctx.fillText('Z', origin.x - axisLength * 0.7 - 15, origin.y - axisLength * 0.7);
        }
    </script>
</body>
</html>
